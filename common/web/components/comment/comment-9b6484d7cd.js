define(function(require,t,e){"use strict";require("./comment-c3995cfd0e.css");var n,o,c,a,i,r,m="http://comment.diandong.com/comment/list",s="http://comment.diandong.com/comment/post",u="http://comment.diandong.com/comment/up";o=require("user"),c=require("pagination"),a=require("tip"),r=require("./comment.tpl"),i=require("ajaxform"),n=function(t){this.options=t,this.init(t)},n.prototype={cache:{},replyId:"",init:function(t){this.render(t.holder),this.checkLogin(),this.getCommentList(1,t.pageNum,t.uuid),this.bindEvent(t)},bindEvent:function(t){var e=this;$(document).on("click",".j-page",function(n){e.getCommentList($(n.currentTarget).data("page"),t.pageNum,t.uuid)}),$(document).on("click",".j-submit-comment",function(n){return $(n.currentTarget).hasClass("disabled")?!1:void e.postComment(t)}),$(document).on("click",".j-reply-comment",function(n){var o=$(n.currentTarget).parents(".comment-item"),c=o.data("comment-id"),a=o.data("comment-uname");e.replyId=c,$(".comment-content-textarea").val("回复 "+a+" "),e.focusTextarea(t.holder)}),$(document).on("click",".j-like-comment",function(e){if(o.id)if($(e.currentTarget).hasClass("on"))a.info("您已经赞过");else{var n=$(e.currentTarget).data("cid"),c=$(e.currentTarget).data("ups");$(e.currentTarget).addClass("on"),$(e.currentTarget).find("span").html(+c+1),$.ajax({url:u,data:{cid:n,uuid:t.uuid},dataType:"jsonp",type:"GET",success:function(t){a.success("点赞成功")}})}else a.info("请先登录")})},render:function(t){var e=juicer(r.box,{});t.html(e)},checkLogin:function(){if(o.id){$(".comment-form-cover").addClass("fn-hide"),$(".comment-form-content").removeClass("fn-hide");var t=juicer(r.user,{avatar:o.avatar,name:o.nickname});$(".comment-user").html(t)}},focusTextarea:function(t){var e=t.offset().top;window.scrollTo(0,e),$(".comment-content-textarea").focus()},getCommentList:function(t,e,n){var c=this,a={page:t+"",pageNum:e+"",uuid:n};o.id&&(a.uid=o.id),$.ajax({url:m,data:a,dataType:"jsonp",type:"GET",success:function(n){n.state.err||(c.cache=n.data,c.renderCommentList(c.cache),c.renderPage(Math.ceil(c.cache.total/e),t))}})},renderCommentList:function(t){for(var e=[],n=0;n<t.curPageList.length;n++){var o=t.curPageList[n];0!==t.content[o].refID&&(t.content[o].replyCon=t.content[t.content[o].refID].content,t.content[o].replyName=t.content[t.content[o].refID].uname),e[n]=t.content[o]}$(".comment-list-content").html(juicer(r.commentItem,{list:e}))},renderPage:function(t,e){$(".comment-page").html(c.render(t,e))},postComment:function(t){var e=this,n=$.trim($(".comment-content-textarea").val());if(""===n)a.info("请填写评论内容");else{var o={content:n,iframeCross:1,uuid:this.options.uuid};0!==this.replyId&&(o.refID=this.replyId),new i({url:s,data:o,success:function(n){0===n.code?(e.getCommentList(1,t.pageNum,t.uuid),$(".comment-content-textarea").val(""),a.success("评论成功！"),e.replyId=0):a.info(n.description)}})}}},e.exports=n});