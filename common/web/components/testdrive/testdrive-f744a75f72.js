define(function(require,e,t){var i,s,r,d=$('<div id="widget_testdrive_wrapper"></div>'),a=!0,n=require("tip"),o=require("area"),l=require("dialog"),c=require("carselect"),v=require("cityselect"),p=/^1\d{10}$/,u="http://car.diandong.com/api/getJXSByCityCxid/",_="http://mall.diandong.com/order/pre_order/";require("./testdrive.css"),require("./pikaday.css"),r=require("./pikaday.js");var m=['<div class="widget-testdrive-mask JS_drive_mask"></div>','<div class="widget-testdrive js_drive_box">',"<header>","<h3>预约免费试驾</h3>","</header>",'<form class="widget-testdrive-form JS_drive_form">','<input class="JS_activityid" type="hidden" name="pid" value=0>','<dl class="widget-testdrive-selectcar">',"<dt>",'<span class="widget-testdrive-required">*</span>',"<span>请先选择车型：</span>","</dt>","<dd>",'<select class="JS_drive_brand" name="brand"><option value=0>选择品牌</option></select>','<select class="JS_drive_series" name="cxid"><option value=0>选择车系</option></select>','<select class="JS_drive_model" name="pzid"><option value=0>选择车型</option></select>',"</dd>","</dl>",'<table class="widget-testdrive-table">',"<tbody>","<tr>",'<td class="widget-testdrive-ltd">','<span class="widget-testdrive-required">*</span>',"<label>姓名：</label>","</td>",'<td class="widget-testdrive-rtd">','<input class="widget-testdrive-text JS_drive_name" type="text" name="name" maxlength=30>',"</td>","</tr>","<tr>",'<td class="widget-testdrive-ltd">','<span class="widget-testdrive-required">*</span>',"<label>手机：</label>","</td>",'<td class="widget-testdrive-rtd ">','<input class="widget-testdrive-text JS_drive_mobile" type="text" name="mobile" maxlength=11>',"</td>","</tr>","<tr>",'<td class="widget-testdrive-ltd">','<span class="widget-testdrive-required">*</span>',"<label>城市：</label>","</td>",'<td class="widget-testdrive-rtd widget-testdrive-citybox">','<select class="JS_drive_province" name="province"><option value=0>选择省份</option></select>','<select class="JS_drive_city" name="city"><option value=0>选择城市</option></select>',"</td>","</tr>","<tr>",'<td class="widget-testdrive-ltd">','<span class="widget-testdrive-required">*</span>',"<label>经销商：</label>","</td>",'<td class="widget-testdrive-rtd ">','<select name="jxsid" class="widget-testdrive-select-jxs JS_drive_jxs"><option value=0>选择经销商</option></select>',"</td>","</tr>","<tr>",'<td class="widget-testdrive-ltd">','<span class="widget-testdrive-required">*</span>',"<label>试驾时间：</label>","</td>",'<td class="widget-testdrive-rtd">','<span class="widget-testdrive-datebox">','<input class="JS_drive_date" type="text" name="drive_date" readonly placeholder="时间">','<i class="widget-testdrive-date-icon"></i>',"</span>",'<select class="widget-testdrive-hour JS_drive_hour" name="drive_time">','<option value="09">09</option>','<option value="10">10</option>','<option value="11">11</option>','<option value="12">12</option>','<option value="13">13</option>','<option value="14">14</option>','<option value="15">15</option>','<option value="16">16</option>','<option value="17">17</option>',"</select>","<span>时</span>",'<span class="JS_drive_car">','<input id="testdrive_shuttle" class="JS_drive_shuttle" type="checkbox" name="pick_up" value=1>','<label for="testdrive_shuttle">免费专车接驾</label>',"</span>",'<span class="testdrive_car_words JS_drive_carwords fn-hide">【6月5日】之后可为您提供免费专车服务</span>',"</td>","</tr>",'<tr class="JS_drive_addrbox fn-hide">','<td class="widget-testdrive-ltd">','<label for="testdrive_addr">出发地点：</label>',"</td>",'<td class="widget-testdrive-rtd">','<input class="widget-testdrive-text JS_drive_addr" type="text" name="addr" maxlength=30>',"</td>","</tr>","</tbody>","</table>",'<div class="widget-testdrive-submit">','<button class="widget-testdrive-submitbtn JS_drive_submitbtn">提交</button>',"</div>","</form>",'<button class="widget-testdrive-close JS_drive_close"></button>',"</div>"].join(""),g=['<button class="con-remind-close j-close-dialog"></button>','<div class="widget-testdrive-success-center clearfix">','<div class="widget-testdrive-successicon"></div>','<div class="widget-testdrive-successwords">','<p class="widget-testdrive-congratulations">恭喜您！预约试驾成功</p>',"<p>电动邦客服人员会尽快与您取得联系，</p>","<p>您也可以致电咨询：<span>4000-990-666</span></p>","</div>","</div>",'<div class="con-remind-ensurebox"><button class="con-remind-ensure j-close-dialog">确认</button></div>'].join(""),h=['<button class="con-remind-close j-close-dialog"></button>','<div class="widget-testdrive-error-center clearfix">','<div class="widget-testdrive-erroricon"></div>','<div class="widget-testdrive-errorwords">','<p class="widget-testdrive-fail">抱歉！提交失败</p>',"<p>详情可致电：<span>4000-990-666</span></p>","</div>","</div>",'<div class="con-remind-ensurebox"><button class="con-remind-ensure widget-testdrive-reapply">重新申请</button></div>'].join("");s={wrapper:"#widget_testdrive_wrapper",drivebox:".js_drive_box",mask:".JS_drive_mask",form:".JS_drive_form",activityid:".JS_activityid",brand:".JS_drive_brand",series:".JS_drive_series",model:".JS_drive_model",name:".JS_drive_name",mobile:".JS_drive_mobile",province:".JS_drive_province",city:".JS_drive_city",jxs:".JS_drive_jxs",date:".JS_drive_date",hour:".JS_drive_hour",car:".JS_drive_car",shuttle:".JS_drive_shuttle",carwords:".JS_drive_carwords",addrbox:".JS_drive_addrbox",addr:".JS_drive_addr",submitbtn:".JS_drive_submitbtn",close:".JS_drive_close",reapply:".widget-testdrive-reapply",errorbox:".con-sale-remind"},i={init:function(e){var t,i,s;s=this.createCalendar(e),t=this.createCarselect(e),i=this.createCityselect(e),this.bindEvent(e,s),t.initCar(0,0,0),o.init(function(){i.initCity(o.id.substring(0,2),o.id)}),this.initJXS(e)},show:function(e,t,i,r){var a,n;this.brand=e?parseInt(e):0,this.series=t?parseInt(t):0,this.model=i?parseInt(i):0,this.activityId=r?parseInt(r):0,$(s.wrapper).length>0?d.show():(this.createElements(),n=this.createCalendar(d),this.carselect=this.createCarselect(d),a=this.createCityselect(d),this.bindEvent(d,n),o.init(function(){a.initCity(o.id.substring(0,2),o.id)})),this.carselect.initCar(this.brand,this.series,this.model),this.initJXS(d);var l=$(window).scrollTop()+($(window).height()-$(s.drivebox,d).height())/2;$(s.drivebox,d).css({top:l}),$(s.activityid,d).val(this.activityId),$(s.name,d).focus()},createElements:function(){$(document.body).append(d),d.html($(m))},bindEvent:function(e,t){function i(){var t=$(v.city,e).val(),i=$(v.series,e).val();this.getJXSData(e,t,i,!0)}var r,o,c=this,v=s,u=new Date,m=864e5,w=3*m;u.setHours(0),u.setMinutes(0),u.setSeconds(0),r=(new Date).getTime(),o=(new Date).getTime()+w,$(v.shuttle,e).on("change",function(i){this.checked?(t.setMinDate(o),$(v.addrbox,e).show()):(t.setMinDate(r),$(v.addrbox,e).hide())}),$(v.date,e).on("change",function(){var t=$(this).val(),i=new Date(t),s=new Date(o+m),r=s.getMonth()+1,d=s.getDate();i.getTime()<o?($(v.carwords,e).html("【"+r+"月"+d+"日】之后可为您提供免费专车服务").show(),$(v.car,e).hide()):($(v.carwords,e).hide(),$(v.car,e).show())}),$(v.close,e).on("click",function(){e.hide()}),$(v.submitbtn,e).on("click",function(t){if(t.preventDefault(),!a)return void(a=!1);if(0==$(v.model,e).val())return void n.error("请选择车型");if(""==$(v.name,e).val())return void n.error("请填写姓名");if(!p.test($(v.mobile,e).val()))return void n.error("请输入正确的手机号码");if(0==$(v.city,e).val())return void n.error("请选择城市");if(0==$(v.jxs,e).val())return void n.error("请选择经销商");if(0==$(v.date,e).val())return void n.error("请选择试驾日期");var i=$(v.date,e).val(),s=new Date(i.substring(0,4),parseInt(i.substring(5,7))-1,i.substring(8,10)),r=new Date(o+m),c=r.getMonth()+1,u=r.getDate();return s.getTime()<o&&$(v.shuttle,e)[0].checked?void n.error("【"+c+"月"+u+"日】之后可为您提供免费专车服务"):void $.ajax({url:_,dataType:"jsonp",data:$(v.form,e).serialize(),success:function(t){e==d&&e.hide(),t.state.err===!1?l.show(g,{className:"con-sale-remind",hasCloseBtn:!1}):l.show(h,{className:"con-sale-remind",hasCloseBtn:!1}),a=!0}})}),$(document).on("click",v.reapply,function(t){$(this).parents(v.errorbox).find(v.close).trigger("click"),e==d&&e.show()}),$(v.series,e).change(function(){i.call(c)}),$(v.city,e).change(function(){i.call(c)})},request:function(e,t){$.ajax({url:e,type:"get",dataType:"jsonp",success:t})},getJXSData:function(e,t,i,s){var r=this,d=u+t+"/"+i;t&&i&&this.request(d,function(t){var i=t.data;!i&&s&&n.error("该城市暂无经销商"),r.createJXSElements(i,e)})},createJXSElements:function(e,t){for(var i='<option value="0">选择经销商</option>',r=0;r<e.length;r++){var d=e[r],a='<option value="'+d.jxsid+'">'+d.addr+"</option>";i+=a}$(s.jxs,t).html(i)},initJXS:function(e){var t,i=this;t=setTimeout(function(){var r=$(s.city,e).val(),d=$(s.series,e).val();return 0==r||0==d?(clearTimeout(t),void i.initJXS(e)):void i.getJXSData(e,r,d,!1)},200)},createCalendar:function(e){var t,i=new Date,r=i.getTime();return i.setTime(r+864e5),t=new Pikaday({field:$(s.date,e)[0],firstDay:1,minDate:i,maxDate:new Date("2020-12-31"),yearRange:[2015,2020]})},createCarselect:function(e){var t=new c({elements:{brand:$(s.brand,e),series:$(s.series,e),model:$(s.model,e)},nomarket:!1,onsale:!0});return t},createCityselect:function(e){var t=new v({elements:{province:$(s.province,e),city:$(s.city,e)}});return t}},t.exports=i});